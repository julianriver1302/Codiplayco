<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Foros - CodiPlay</title>
	<link rel="stylesheet" th:href="@{/assetsPanelUsuaario/styleUsuario.css}">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	
</head>
<body>

	<div class="dashboard-container">
		<!-- SIDEBAR -->
		<aside class="sidebar">
			<div class="logo-container">
				<div class="logo-icon">
					<i class="fa-solid fa-robot"></i>
				</div>
				<span class="logo-text">CodiPlay</span>
			</div>

			<nav class="sidebar-menu">
				<ul>
					<li>
						<a th:href="@{/PanelControlUsuario/inicio}">
							<i class="fa-solid fa-house"></i>
							<span>Inicio</span>
						</a>
					</li>
					<li>
						<a th:href="@{/PanelControlUsuario/mis_cursos}">
							<i class="fa-solid fa-book-open"></i>
							<span>Mis cursos</span>
						</a>
					</li>
					<li>
						<a th:href="@{/PanelControlUsuario/mis_logros}">
							<i class="fa-solid fa-trophy"></i>
							<span>Mis logros</span>
						</a>
					</li>
					<li>
						<a th:href="@{/PanelControlUsuario/bandeja}">
							<i class="fa-solid fa-inbox"></i>
							<span>Bandeja</span>
						</a>
					</li>
					<li class="active">
						<a th:href="@{/PanelControlUsuario/foros}">
							<i class="fa-solid fa-users"></i>
							<span>Foros</span>
						</a>
					</li>
				</ul>
			</nav>

			<div class="sidebar-footer">
				<a th:href="@{/PanelControlUsuario/soporte}" class="support-link">
					<i class="fa-solid fa-headset"></i>
					<span>Soporte</span>
				</a>
			</div>
		</aside>

		<!-- MAIN CONTENT -->
		<main class="main-content">
			
			<!-- HEADER -->
			<header class="top-header">
				<button class="mobile-nav-toggle" type="button">
					<i class="fa-solid fa-bars"></i>
				</button>
				<!-- TÍTULO SUPERIOR CON ICONO -->
				<div class="forums-page-title">
					<i class="fa-solid fa-comments"></i>
					<h1>Foros</h1>
				</div>
				<div class="search-bar search-bar--hidden-foros">
					<i class="fa-solid fa-magnifying-glass"></i>
					<input type="text" placeholder="Buscar en foros...">
				</div>

				<div class="user-actions" style="display: flex; align-items: center; gap: 20px;">
					<div class="icon-btn theme-btn" id="theme-toggle" title="Cambiar Tema">
						<i class="fa-solid fa-moon"></i>
					</div>
					<div class="user-profile" id="user-profile-toggle">
						<div class="avatar">
							<img th:if="${usuario != null and usuario.avatar != null and !#strings.isEmpty(usuario.avatar)}"
								th:src="@{'/uploads/avatars/' + ${usuario.avatar}}" alt="User Avatar"
								class="avatar-img" />
							<img th:unless="${usuario != null and usuario.avatar != null and !#strings.isEmpty(usuario.avatar)}"
								th:src="@{/assetsPanelUsuaario/22b8078e-03d9-49d7-a4a6-f70b4208e8c9-removebg-preview.png}"
								alt="User Avatar" class="avatar-img" />
						</div>
						<span class="username"
							th:text="${usuario != null} ? ${usuario.nombre} : 'Usuario'">Usuario</span>
						<i class="fa-solid fa-chevron-down" style="font-size: 12px; margin-left: 4px;"></i>
					</div>
					<div class="user-menu" id="user-menu" style="display: none;">
						<a th:href="@{/PanelControlUsuario/editar-perfil}"><i class="fa-solid fa-user-pen"></i> Editar perfil</a>
						<a th:href="@{/logout}"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</a>
					</div>
				</div>
			</header>

			<!-- CONTENIDO FOROS -->
			<div class="content-area full-height-center">
				
				<!-- Mensaje de error si existe -->
				<div th:if="${error}" class="alert alert-danger" th:text="${error}" style="margin-bottom: 20px;"></div>

				<!-- ESTADO VACÍO (sin foros) -->
				<div class="empty-forum-state" th:if="${forosPorCurso == null or forosPorCurso.isEmpty()}">
					<div class="empty-icon-simple">
						<i class="fa-regular fa-comments"></i>
					</div>
					<h2>Foros</h2>
					<p>No hay foros disponibles en este momento.</p>
				</div>

				<!-- LISTA DE FOROS (cuando sí hay) -->
				<div class="forums-panel" th:if="${forosPorCurso != null and not forosPorCurso.isEmpty()}">
					<h2 class="forums-panel-title">Foros de Discusión</h2>

					<div th:each="entry : ${forosPorCurso.entrySet()}" class="foro-curso-bloque">
						<h3 class="foro-curso-titulo">
							<i class="fas fa-book"></i>
							<span th:text="${entry.key.curso}">Nombre curso</span>
						</h3>

						<div th:if="${!#lists.isEmpty(entry.value)}">
							<div class="foro-list">
								<div th:each="foro : ${entry.value}" class="foro-item">
									<div class="foro-icon">
										<i class="far fa-comment-dots"></i>
									</div>
									<div class="foro-content">
										<h4 class="foro-title" th:text="${foro.titulo}">Título foro</h4>
										<p class="foro-desc" th:text="${foro.descripcion}">Descripción del foro</p>
										<div class="foro-meta">
											<i class="far fa-clock"></i>
											<span th:text="${#temporals.format(foro.fechaCreacion, 'dd/MM/yyyy HH:mm')}">Fecha</span>
											<span class="respuestas-count" th:if="${respuestasPorForo != null and respuestasPorForo.containsKey(entry.key.id) and respuestasPorForo[entry.key.id].containsKey(foro.id)}">
												<i class="far fa-comments"></i>
												<span th:text="${respuestasPorForo[entry.key.id][foro.id]} + ' respuesta' + (${respuestasPorForo[entry.key.id][foro.id]} == 1 ? '' : 's')">0 respuestas</span>
											</span>
											<span class="respuestas-count" th:if="${respuestasPorForo == null or not respuestasPorForo.containsKey(entry.key.id) or not respuestasPorForo[entry.key.id].containsKey(foro.id)}">
												<i class="far fa-comments"></i>
												0 respuestas
											</span>
										</div>
									</div>
									<div class="foro-actions">
										<a th:href="@{'/PanelControlUsuario/foros/' + ${foro.id}}" class="btn-action" title="Ver foro y responder">
											<i class="far fa-comment"></i>
										</a>
									</div>
								</div>
							</div>
						</div>

						<div class="foro-curso-empty" th:if="${#lists.isEmpty(entry.value)}">
							<i class="far fa-comment-slash"></i>
							No hay foros para este curso aún.
						</div>
					</div>
				</div>

			</div>

		</main>
	</div>

	<script th:src="@{/assetsPanelUsuaario/inicio.js}"></script>
	<script>
		// Toggle simple del menú de usuario al hacer clic en el chip
		(function () {
			const profile = document.getElementById('user-profile-toggle');
			const menu = document.getElementById('user-menu');
			if (!profile || !menu) return;

			profile.addEventListener('click', function (e) {
				e.stopPropagation();
				const visible = menu.style.display === 'block';
				menu.style.display = visible ? 'none' : 'block';
			});

			// Cerrar el menú si se hace clic fuera
			document.addEventListener('click', function () {
				menu.style.display = 'none';
			});
		})();
	</script>
</body>
</html>
